%\documentclass{segabs}
\documentclass[manuscript,ulem,graphix,revised]{geophysics}

\usepackage{amsmath}
\usepackage{graphicx}
%\usepackage{epstopdf}
%\usepackage{slashbox}
\usepackage{hanging}
\usepackage{mathrsfs}
\usepackage{marginnote}
\usepackage{amssymb} 
\usepackage{url}

%\usepackage{tikz}
%\usepackage{geometry}
%\usepackage{setspace}
%\usepackage[margin=0.8in]{geometry}
%\usepackage{float}
%\usepackage{subfig}
%\usepackage{subcaption}

\usepackage{indentfirst}
\makeatletter
\newcommand*{\rom}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother
\begin{document}

\title{\uline{3D isotropic elastic reverse time migration using signed magnitudes of elastic components}}
\marginpar{[3]}
%\renewcommand{\thefootnote}{\fnsymbol{footnote}} 

%\address{
%\footnotemark[1]Department of Mathematics, Harbin Institute of Technology,
%92 Xidazhi St., Nangang Dist., Harbin, Heilongjiang, China 150001
%
%\footnotemark[2]Center for Lithospheric Studies, 
%The University of Texas at Dallas, \\
%800 W Campbell Road (ROC21), Richardson, TX, USA 75080
%}
%
%\author{Wenlong Wang\footnotemark[1] and George A. McMechan\footnotemark[2]}
\author{\vspace{-9ex}}
\righthead{3D elastic RTM}

%\maketitle

%\clearpage
%\newpage
\renewcommand{\figdir}{Fig} % figure directory

\begin{abstract}

Elastic reverse time migration (ERTM) is capable of characterizing subsurface properties more completely than its acoustic counterpart. P- and S-waves coexist in elastic wavefields, and their separation is required before, or as part of, applying the image conditions. Traditional P- and S-wave separation methods based on divergence and curl operators don't preserve the elastic vector information, and the associated polarity reversals of S-wave images are difficult to handle. Thus a preferable workflow for isotropic ERTM should include a vector decomposition of the elastic wavefields and a vector-based image condition that directly uses the signed magnitudes of the decomposed vector wavefields to produce PP and PS images. 
\marginpar{[1,4,12]}\uline{We propose a new 3D elastic image condition which is a source-normalized crosscorrelation of the signed magnitudes of the decomposed wavefields.
The image condition is robust and stable for generating 3D PP and PS images and their corresponding angle domain common-image gathers (ADCIGs) with incident angles calculated from Poynting vectors.
Comparisons between the proposed image condition and a vector-based dot-product image condition and show that the proposed image condition generates PP ADCIGs with a wider range of incident angles than existing dot-product image conditions.
}
\end{abstract}

\section{Introduction}

Elastodynamic wave equations can simulate seismic wave propagation with fewer assumptions than acoustic wave equations, as the former include both shear- and compressional wave propagations. 3D elastic migration, with multicomponent data as input, provides the foundation for structure imaging and elastic parameter estimation.

Migration of multicomponent data has been attempted in the past, using either ray-based or wave-based solutions. Ray-based examples include Kirchhoff migration \citep{kuo84, dai86, hokstad00}, where PP- and PS-wave traveltimes are calculated and amplitudes are summed along their corresponding traveltime trajectories. The PS separation is done implicitly by using P- and S-velocity models to compute the corresponding traveltimes. Multicomponent elastic Kirchhoff migration has the same limitations as acoustic Kirchhoff migrations; wave phenomena cannot be fully described by ray theory if the geology becomes complicated \citep{gray01}. Wave-based solutions \citep{chang86,chang94,whitmore95}, on the other hand, reconstruct the wavefields with a wave equation \citep{wapenaar90}, and have fewer limitations than ray-based migrations. \citet{sun01} separate multicomponent data near the surface and use acoustic equations for separate PP and PS migrations. Elastic reverse time migration (ERTM) utilizes elastic wave equations directly, and constructs the source elastic wavefields forward in time and reconstructs the receiver elastic wavefields backward in time by using multicomponent seismic data as initial, and boundary conditions, respectively.

Different image conditions are applied in ERTMs. Early attempts include the excitation time image condition \citep{chang86}, in which the image time is calculated by raytracing from the source point. The crosscorrelation image condition \citep{claerbout85} remains the standard image condition for acoustic RTMs, but in ERTMs, a component-by-component crosscorrelation causes crosstalk between the unseparated P- and S-waves leads to artifacts which pose difficulties in interpretation. \citet{yan08} apply divergence and curl operators to separate the P- and S-waves before applying the crosscorrelation image condition and demonstrate improvements in image quality. \marginpar{[10]} \uline{The polarity reversal problem of the PS image is generated by the curl operators and needs special treatment/corrections \mbox{\citep{du12,du14}} to avoid destructive interference in post-migration stacking. This phase shift does not occur in the proposed algorithm.} 
\marginpar{[2]}\uline{\mbox{\citet{rocha16}} propose an energy norm image condition for elastic imaging which constructs a single image from all wave modes, thus no wave mode separation or decompositions are needed. However, the P- and S-waves have distinctive properties during propagation in different media, and generating PP and PS images separately is helpful for interpretation purposes, for example the detection of fluids \mbox{\citep{stewart90}}.} 

Recently, P- and S-wave vector decomposition \citep{ma03,zhang07,wenlong_cmp15,wenlong_pv16,zhu17,wenlong17} is gaining popularity. Vector decomposition preserves the amplitude and phase in the input elastic wavefield and retains the same physical magnitude and units, and thus is considered to be more accurate than using divergence and curl operators which change the phase and amplitude of the input wavefield. \citet{wang_cl16} and \uline{\mbox{\citet{du17}} obtain decomposed elastic vectors from a source and receiver wavefield and use a dot product type of crosscorrelation image condition to generate images}. The dot product, however, leads to image amplitude changes as a function of the open angle between the incident and reflected (converted) waves, causing difficulties in AVA analysis. \uline{\mbox{\citet{du17}} also propose to crosscorrelate P-wave stresses as an alternative to construct PP images.} \citet{wenlong_vct15,wenlong_3d16} use the signed magnitude ratio to construct images by a 2D (or 3D) excitation amplitude image condition. 
This image condition applies Poynting vectors \citep{cerveny01} calculated from decomposed P- and S-waves to obtain angle-domain common-image gathers (ADCIGs). \marginpar{[6]} \uline{The excitation amplitude image condition \mbox{\citep{nguyen13,wenlong_vct15}}} \newline\uline{features a significant reduction in the source wavefield storage and the I/O burden, but it requires sophisticated improvements to include multipathing \mbox{\citep{jin15}}, which is common in complicated models.}\marginpar{[1,4,5,6]} \uline{In this paper, we extend the previous excitation amplitude based elastic image condition to a more robust source-normalized magnitude-crosscorrelation type image condition and apply it to 3D ERTMs.}

P- and S-wave vector decomposition is also possible in anisotropic wavefields \citep{cheng14,wenlong17}. However, we limit the scope of this initial elastic paper to isotropic media, as a main goal is the proof of concept. The paper is organized as follows; first the methodology for obtaining decomposed P- and S-wave vectors is described. Then we illustrate the procedure for implementing the 3D source-normalized magnitude-crosscorrelation elastic image condition. To limit the scope, only PP and PS images are generated and analyzed in this paper.
%the relation between our image condition and dot product image condition is discussed. 
The proposed 3D ERTM procedure is successfully tested on a single-layer model and a portion of the SEG/EAGE Overthrust model \citep{aminzadeh94}. 

\section{Methodology}

The procedure of 3D source-normalized magnitude-crosscorrelation ERTM is similar to that of the 2D excitation amplitude ERTM image condition \citep{wenlong_vct15}. In ERTMs, the source wavefield is extrapolated before the receiver wavefield extrapolation. Both elastic wavefield extrapolations involve P- and S-wavefield decompositions. The decomposed P- and S-wave particle-velocities and stresses are used to obtain their propagation directions and reflection polarities. 
%Due to the different polarizations of PP and PS reflections, their image conditions are also different. 
In the following subsections, the procedures are explained and illustrated in detail.

\subsection{3D elastic wavefield extrapolation and PS decomposition}

We use the 3D stress-particle-velocity formulation proposed by Madariaga (\citeyear{madariaga76}) and Virieux (\citeyear{virieux84}, \citeyear{virieux86}), which includes the general Hooke's law
\begin{subequations}
\begin{equation}
\frac{\partial\tau_{xx}}{\partial t}=(\lambda+2\mu)(\frac{\partial v_x}{\partial x}+\frac{\partial v_y}{\partial y}+\frac{\partial v_z}{\partial z})-2\mu(\frac{\partial v_y}{\partial y}+\frac{\partial v_z}{\partial z}),
\end{equation}
\begin{equation}
\frac{\partial\tau_{yy}}{\partial t}=(\lambda+2\mu)(\frac{\partial v_x}{\partial x}+\frac{\partial v_y}{\partial y}+\frac{\partial v_z}{\partial z})-2\mu(\frac{\partial v_x}{\partial x}+\frac{\partial v_z}{\partial z}),
\end{equation}
\begin{equation}
\frac{\partial\tau_{zz}}{\partial t}=(\lambda+2\mu)(\frac{\partial v_x}{\partial x}+\frac{\partial v_y}{\partial y}+\frac{\partial v_z}{\partial z})-2\mu(\frac{\partial v_x}{\partial x}+\frac{\partial v_y}{\partial y}),
\end{equation}
\begin{equation}
\frac{\partial\tau_{xy}}{\partial t}=\mu(\frac{\partial v_x}{\partial y}+\frac{\partial v_y}{\partial x}),
\end{equation}
\begin{equation}
\frac{\partial\tau_{xz}}{\partial t}=\mu(\frac{\partial v_x}{\partial z}+\frac{\partial v_z}{\partial x}),
\end{equation}
\begin{equation}
\frac{\partial\tau_{yz}}{\partial t}=\mu(\frac{\partial v_y}{\partial z}+\frac{\partial v_z}{\partial y}), 
\end{equation}
\label{eqn:stress-velocity1}
\end{subequations}
and the equations of motion
\begin{subequations}
\begin{equation}
\rho\frac{\partial v_x}{\partial t}=\frac{\partial\tau _{xx}}{\partial x}+\frac{\partial\tau _{xy}}{\partial y}+\frac{\partial\tau _{xz}}{\partial z},
\end{equation}
\begin{equation}
\rho\frac{\partial v_y}{\partial t}=\frac{\partial\tau _{xy}}{\partial x}+\frac{\partial\tau _{yy}}{\partial y}+\frac{\partial\tau _{yz}}{\partial z},
\end{equation}
%\text{and}
\begin{equation}
\rho\frac{\partial v_z}{\partial t}=\frac{\partial\tau _{xz}}{\partial x}+\frac{\partial\tau _{yz}}{\partial y}+\frac{\partial\tau _{zz}}{\partial z},
\end{equation}
\label{eqn:stress-velocity2}
\end{subequations}
\noindent{where $\tau$ is stress and $v$ is particle-velocity, and the subscripts indicate $x$, $y$ or $z$ coordinates.}

%PS decomposition is necessary to get clear PP and PS images free from artifacts. 
The stress-particle-velocity formulation extrapolates 3D isotropic elastic wavefields with coupled P- and S-waves; if they are not separated either before extrapolation, or as part of the image condition, they will be superimposed as 'crosstalk' artifacts in the migrated images. Instead of using divergence and curl operators, which produce scalar and vector pseudo-potentials rather than particle vector components \citep{aki80,yan08}, we decompose the wavefields while preserving their vector amplitude and phase. This can be achieved by calculating an auxiliary P-wave stress $\tau^p$, which is a scalar wavefield similar to pressure in the acoustic wave equation, while solving the complete stress-particle-velocity formulation in equations \ref{eqn:stress-velocity1} and \ref{eqn:stress-velocity2}. The calculation for P-wave stress has a scalar form \citep{xiao10} 
\begin{equation}
\frac{\partial\tau_{p}}{\partial t}=(\lambda+2\mu)(\frac{\partial v_x}{\partial x}+\frac{\partial v_y}{\partial y}+\frac{\partial v_z}{\partial z}).
\label{eqn:tau-p}
\end{equation}
Then the horizontal and vertical particle-velocity components of P-waves, $v^p_{x}$, $v^p_{y}$ and $v^p_{z}$, are calculated from $\tau^p$ by finite differencing
\begin{subequations}
\begin{equation}
\frac{\partial v^p_{x}}{\partial t}=\frac{1}{\rho}\frac{\partial\tau _{p}}{\partial x},
\end{equation}
\begin{equation}
\frac{\partial v^p_{y}}{\partial t}=\frac{1}{\rho}\frac{\partial\tau _{p}}{\partial y},
\end{equation}
\text{and}
\begin{equation}
\frac{\partial v^p_{z}}{\partial t}=\frac{1}{\rho}\frac{\partial\tau _{p}}{\partial z}.
\end{equation}
\label{eqn:vp}
\end{subequations}
This gives a complete description of the vector P-wavefield; the S-wavefield can be obtained by subtracting the P-wavefield from the complete wavefield, component-by-component
\begin{subequations}
\begin{equation}
v^s_{x}=v_x-v^p_{x},
\end{equation}
\begin{equation}
v^s_{y}=v_y-v^p_{y},
\end{equation}
\text{and}
\begin{equation}
v^s_{z}=v_z-v^p_{z},
\end{equation}
\label{eqn:vs}
\end{subequations}
where $v^s_x$,  $v^s_y$ and $v^s_z$ are the $x$, $y$ and $z$ direction particle-velocity components of the S-waves. 

An example of elastic wavefield decomposition is shown in Figure~\ref{fig:homo_snap.eps}, where an explosive source and a rotational source in the x-z plane are placed at the center of a homogeneous model with propagation velocities vp = 2.5 km/s, vs= 1.6 km/s, and $\rho$ = 2.1 $\mathrm{kg/cm^3}$. The first row (Figure~\ref{fig:homo_snap.eps}a-\ref{fig:homo_snap.eps}c) are the x, y and z components of the original elastic wavefield snapshot; the second (Figure~\ref{fig:homo_snap.eps}d-\ref{fig:homo_snap.eps}f) and the third (Figure~\ref{fig:homo_snap.eps}g-\ref{fig:homo_snap.eps}i) rows are the corresponding decomposed components of the P and the S waves with vector components preserved. 
\plot{homo_snap.eps}{width=1.0\columnwidth}
{
An elastic wavefield decomposition example in a homogeneous model.
(a)-(c) are the X, Y and Z components of the original particle-velocity components;
(d)-(f) are the X, Y and Z components of the decomposed P-wave particle-velocity components;
(g)-(i) are the X, Y and Z components of the decomposed S-wave particle-velocity components;
}


\subsection{3D source-normalized magnitude-crosscorrelation ERTM image condition}

%Different from the crosscorrelation image condition \citep{wang_cl16},
%the image time $T$ is determined as the one-way time, from the source to each grid point, that corresponds to the maximum amplitude during the source wavefield extrapolation over all times
During the source wavefield extrapolation, the decomposed P-wavefield needs to be stored as time series snapshots, which includes the particle-velocities ($v^p_{(src)x}, v^p_{(src)y},v^p_{(src)z}$) and the P-wave stress $\tau^p$. The vector magnitudes of the particle-velocities of the source and receiver wavefields are crosscorrelated in the image condition, and both particle-velocities and stresses of each wavefield are input to obtain Poynting vectors \citep{cerveny01}.%\begin{equation}
%T(x,y,z)=\mathrm{argmax}[t|A(x,y,z,t)],
%\label{eqn:tmap}
%\end{equation}
%where $A$ is the amplitude of the source wavefield, and $T$ is the time $t$ corresponding to the maximum value of $A$ at each $(x,y,z)$ over all times. The image time $T(x,y,z)$ determines when to apply the image condition at $(x,y,z)$ during the reverse-time receiver wavefield extrapolation, to produce images.
%
%As in the 2D vector-based image condition \citep{wenlong_vct15} the vector magnitude
%\begin{equation}
%A=|(v^p_{src,x}, v^p_{src,y},v^p_{src,z})|
%\label{eqn:amap}
%\end{equation}
%represents the source amplitude, where $v^p_{src,i}$ ($i$ = $x$, $y$ and $z$) are the components of the source P-wavefield particle-velocity vector, and the $|\cdot|$ operator calculates the magnitude of the vector argument. The P-wave particle-velocity vector components of the source wavefield
%\begin{equation}
%\mathbf{V^p_{src}}=(v^p_{src,x}, v^p_{src,y},v^p_{src,z})_{t=T}
%\label{eqn:vctmap1}
%\end{equation}
%are also saved at the time $T$ when the maximum amplitude $\Gamma^p$ is reached at each $(x,y,z)$ location, as well as their corresponding P-wave stress
%\begin{equation}
%\Gamma^p=\tau^p_{t=T}.
%\label{eqn:vctmap2}
%\end{equation}
%The reason for saving both $\mathbf{V^p_{src}}$ and $\Gamma^p$ is that both are necessary for calculating the P-wave propagation directions via Poynting vectors \citep{cerveny01}
\begin{equation}
s^{p}_j=-\tau^p v^p_j,
\label{eqn:poynting_p}
\end{equation}
where 
$s^{p}_j$ are the P-wave Poynting vector components, and
$v^p_j$ are the components of the decomposed P-wave particle-velocity, for $j$ = $x$, $y$, $z$. In this paper, we are interested in the PP and PS images, in which the incident wavefields are P-waves only; thus the S-wave Poynting vectors are not required to be calculated, although this has been done by \citet{wenlong_pv16}.

%is also saved for calculating the propagation direction using the Poynting vector. The P-wave stress $\tau^p$ has a scalar form and so the saved stress $\Gamma^p$ also has only one value at each grid point. The reason for saving both $\mathbf{V^p_{src}}$ and $\Gamma^p$ is that both are necessary for generating Poynting vectors using equation~\ref{eqn:poynting_p} \citep{dickens11}, and $\mathbf{V^p_{src}}$ is also needed for determining the sign of the reflection coefficient in the following procedure; saving only the maximum amplitude and propagation direction is not sufficient.


%During the reverse-time receiver extrapolation, the receiver wavefield amplitude is extracted at each grid point at its image time $T(x,y,z)$. 
The reverse-time receiver extrapolation follows the source extrapolation, during which the image condition is applied. We use the signed-magnitude crosscorrelation to construct the image. 
% The propagation directions of reflected P-wave ($\mathbf{s}^{\mathbf{p}}_{\mathbf{rec}}$) and converted S-wave ($\mathbf{s}^{\mathbf{s}}_{\mathbf{rec}}$) are calculated using the Poynting vector equations~\ref{eqn:poynting_p} and \ref{eqn:poynting_s} with separated receiver wavefield vectors. 
%To make the values of the images physically meaningful, we need to get the angle-dependent reflectivity information from the image condition; the most straightforward method is to use the magnitude of the reconstructed receiver particle-velocity wavefield divided by that of source wavefield. However, magnitudes are always positive, so we also need to know the corresponding sign of reflection. Thus the application of the vector-based image condition can be decomposed into two steps:
During application of the image condition, the signs of the reflections (of both PP and PS) are calculated as a function of position, incident angle and azimuth angle.
The signs of both PP and PS reflections can be determined from the principle that the incident and the reflected waves have the same polarity for a negative reflection coefficient, and opposite polarity for a positive reflection coefficient \citep{aki80}. For 3D models, the calculation for the signs of the reflections is more complicated. 
We assume only P-waves are present in the source wavefield, so theoretically, the reflections are all either PP or PSV, and the particle-velocity directions, propagation directions, and reflector normal are all in the same plane, for a reflection at a grid point. The azimuth angle is obtained from 
\marginpar{[5]}
\begin{equation}
\phi=\mathrm{atan2}[s^{p}_{(src)y},\ s^{p}_{(src)x}],
\label{eqn:azm_agl}
\end{equation}
where $s^{p}_{(src)x}$ and $s^{p}_{(src)y}$ are the $x$ and $y$ components of the P-wave Poynting vectors (equation~\ref{eqn:poynting_p}) calculated from the source wavefield at each grid point and image time. For PP reflections, the incident and reflection angles are the same in an isotropic medium. The incident angle $\theta$ can then be solved from the vector dot product geometrical relation \citep{du17,shabelansky17,zhu17} as
\begin{equation}
\mathbf{\tilde{S}^{p}_{src}}\cdot \mathbf{\tilde{S}^p_{rec}}=|\mathbf{\tilde{S}^{p}_{src}}||\mathbf{\tilde{S}^p_{rec}}|\mathrm{cos}(2\theta),
\label{eqn:inc_agl}
\end{equation}
where the $\mathbf{\tilde{S}^{p}_{src}}$ and $\mathbf{\tilde{S}^p_{rec}}$ are the normalized decomposed P-wave Poynting vectors of the source and the receiver wavefields, respectively. \marginpar{[7,8]} \uline{During the normalization, a threshold is applied to the magnitudes of the Poynting vectors, which are used as denominators for normalization, to prevent division by zero. This scheme is applied to both elastic image conditions which are compared in the Synthetic test section.}  $|\cdot|$ represents the magnitude of the vector arguement. \marginpar{[5]}\uline{As proposed by \mbox{\citet{du14}}, the reflector normal direction $\overrightarrow{\mathbf{n}}$ can be obtained from}
% solving the equation system~\ref{eqn:rfl_nor}. 
\begin{equation}
\overrightarrow{\mathbf{n}}=\mathbf{\tilde{S}^p_{rec}}-\mathbf{\tilde{S}^{p}_{src}}.
\end{equation}
%\begin{equation}
%\left\{
%\begin{array}{lr}
%\mathbf{s^{p}_{src}}\cdot \mathbf{n}=|\mathbf{s^{p}_{src}}|\mathbf{n}|cos(\theta) \\
%\mathbf{s^p_{rec}}\cdot \mathbf{n}=-|\mathbf{s^p_{rec}}|\mathbf{n}|cos(\theta) \\
%|\mathbf{n}|=1
%\end{array}
%\right.
%\label{eqn:rfl_nor}
%\end{equation}
Similarly, the reflector dip direction $\overrightarrow{\mathbf{d}}$ can be calculated from \marginpar{[14]}
\begin{equation}
\overrightarrow{\mathbf{d}}=\mathbf{\tilde{S}^p_{rec}}+\mathbf{\tilde{S}^{p}_{src}}.
\end{equation}
\marginpar{[7,8]}\uline{To stabilize the Poynting vectors in complex wavefields, we apply a median filter to the calculated propagation directions in the space domain \mbox{\citep{jin14}}.}
% solving the equation system:
%\begin{equation}
%\left\{
%\begin{array}{lr}
%\mathbf{s^{p}_{src}}\cdot \mathbf{r}=|\mathbf{s^{p}_{src}}|\mathbf{r}|sin(\theta) \\
%\mathbf{s^p_{rec}}\cdot \mathbf{r}=|\mathbf{s^p_{rec}}|\mathbf{r}|sin(\theta) \\
%|\mathbf{r}|=1
%\end{array}
%\right.
%\label{eqn:rfl_nor1}
%\end{equation}
 

\plot{3D_comb.eps}{width=1.0\columnwidth}
{
Kinematic example of (a) PP and (b) PS reflection particle-velocities and corresponding polarities (3D). 
}

The polarity of a PP reflection can be observed through its particle motion normal to the reflector (Figure~\ref{fig:3D_comb.eps}a). To determine if the polarity of the PP reflection changes at a grid point, 
the recorded source P-wave particle-velocity vector $\mathbf{V}^{\mathbf{p}}_{\mathbf{src}}$ can be projected to the reflector normal direction $\overrightarrow{\mathbf{n}}$, to give the projected vector $\hat{\mathbf{V}}^{\mathbf{p}}_{\mathbf{src}}$. Then 
the decomposed P-wave particle-velocity components of the receiver wavefield $\mathbf{V}^{\mathbf{p}}_{\mathbf{rec}}$ can also be projected to the reflector normal direction $\overrightarrow{\mathbf{n}}$ to give $\hat{\mathbf{V}}^{\mathbf{p}}_{\mathbf{rec}}$. The sign of PP reflection at each grid point can be obtained from
\begin{equation}
%\begin{aligned}
\mathrm{sgn_{pp}}(x,y,z,t,\theta, \phi)=\begin{cases}
 +1, \ \mathrm{if} \  \hat{\mathbf{V}}^{\mathbf{p}}_{\mathbf{src}}(x,y,z,t) \cdot \hat{\mathbf{V}}^{\mathbf{p}}_{\mathbf{rec}}(x,y,z,t)<0 , \\
 -1, \ \mathrm{if}  \ \hat{\mathbf{V}}^{\mathbf{p}}_{\mathbf{src}}(x,y,z,t) \cdot \hat{\mathbf{V}}^{\mathbf{p}}_{\mathbf{rec}}(x,y,z,t)>0 .
\end{cases}
%\end{aligned}
\label{eqn:sgn_pp}
\end{equation}
where the $\theta$ and $\phi$ are incident and azimuth angles calculated from the Poynting vectors as discussed above.
%if both projections ($\tilde{\mathbf{v}}_{\mathbf{sp}}$ and $\tilde{\mathbf{v}}_{\mathbf{rp}}$) are pointing at the same direction, which means the polarity doesn't change, and the sign of PP reflection at this incident angle is negative, and opposite directions means positive reflections (Figure~\ref{fig:3D_comb.eps}a). 

The polarity change of a PS reflection is determined from its particle motion parallel to the reflector (Figure~\ref{fig:3D_comb.eps}b) \citep{aki80}. Similar to the procedure to get PP reflection signs, we project the recorded source P-wave particle-velocity components $\mathbf{V}^{\mathbf{p}}_{\mathbf{src}}$ and the receiver S-wave particle-velocity components $\mathbf{V}^{\mathbf{s}}_{\mathbf{rec}}$ on the reflector $\mathbf{r}$ to get their projections $\check{\mathbf{V}}^{\mathbf{p}}_{\mathbf{src}}$ and $\check{\mathbf{V}}^{\mathbf{s}}_{\mathbf{rec}}$, and the sign of the PS reflection can be obtained using
\begin{equation}
\mathrm{sgn_{ps}}(x,y,z,t,\theta,\phi)=\begin{cases}
 +1, \ \mathrm{if} \ \check{\mathbf{V}}^{\mathbf{p}}_{\mathbf{src}}(x,y,z,t) \cdot \check{\mathbf{V}}^{\mathbf{s}}_{\mathbf{rec}}(x,y,z,t)<0, \\ 
 -1, \ \mathrm{if} \ \check{\mathbf{V}}^{\mathbf{p}}_{\mathbf{src}}(x,y,z,t) \cdot \check{\mathbf{V}}^{\mathbf{s}}_{\mathbf{rec}}(x,y,z,t)>0 .
\end{cases}
\label{eqn:sgn_ps}
\end{equation}
\marginpar{[1,4,5,10]}\uline{This is different from the polarity correction strategy proposed by \mbox{\citet{du12, du14}}, in which the the polarity reversal problem is brought by the curl operators, while in our approach, the elastic components are preserved after decomposition, as no curl operators are involved, and the polarity doesn't need to be corrected. Equation~\ref{eqn:sgn_ps} is designed to find the sign of PS reflection coefficients from the relations between the polarizations and their propagation directions.}

With knowledge of the signs of a PP or a PS reflection, we use the magnitude of the receiver (reflected) P- or S-waves crosscorrelated with the source (incident) magnitude to obtain an image, and then it is source normalized to represent the reflectivity \citep{sheriff95} at each image point.
%\begin{equation}
%\begin{aligned}
%r_{pp}(x,y,z,\theta,\phi)&=\mathrm{sgn_{pp}}(x,y,z,\theta,\phi)\frac{|\mathbf{V^p_{rec}}(x,y,z)|}{|\mathbf{V^p_{src}}(x,y,z)|},\\
%r_{ps}(x,y,z,\theta,\phi)&=\mathrm{sgn_{ps}}(x,y,z,\theta,\phi)\frac{|\mathbf{V^s_{rec}}(x,y,z)|}{|\mathbf{V^p_{src}}(x,y,z)|},
%\end{aligned}
%\label{eqn:reflectivity}
%\end{equation}
\begin{equation}
\begin{aligned}
I_{pp}(x,y,z)&=\frac{\sum_{t=0}^{T}\mathrm{sgn_{pp}}(x,y,z,t)|\mathbf{V^p_{rec}}(x,y,z,t)||\mathbf{V^p_{src}}(x,y,z,t)|}
                    {\sum_{t=0}^{T}|\mathbf{V^p_{src}}(x,y,z,t)|^2 },\\
I_{ps}(x,y,z)&=\frac{\sum_{t=0}^{T}\mathrm{sgn_{ps}}(x,y,z,t)|\mathbf{V^s_{rec}}(x,y,z,t)||\mathbf{V^p_{src}}(x,y,z,t)|}
                    {\sum_{t=0}^{T}|\mathbf{V^p_{src}}(x,y,z,t)|^2 },
\end{aligned}
\label{eqn:reflectivity}
\end{equation}
where $I_{pp}$ and $I_{ps}$ are PP and PS images. The incident angle $\theta$ and azimuth angle $\phi$ are hidden for simplicity, but need to be included in the evaluation of equation~\ref{eqn:reflectivity}.
%embedded in the Poynting vectors from source and receiver wavefields.% $|\cdot|$ is the magnitude of a vector.

The differences and relations between the proposed image condition and the dot product image condition \citep{wang_cl16, du17} can be found in Appendix A.



\section{Synthetic Tests}

The proposed image condition is first tested on a flat layered elastic model (Figure~\ref{fig:3D_layermodel.eps}). The upper layer has Vp = 2.5 $\mathrm{km/s}$,  Vs = 1.6 $\mathrm{km/s}$ and  $\mathrm{\rho}$ = 2.1 $\mathrm{g/cm^3}$; the lower layer has  Vp = 2.8 $\mathrm{km/s}$,  Vs = 1.7 $\mathrm{km/s}$ and  $\mathrm{\rho}$ = 2.2 $\mathrm{g/cm^3}$.
The wavefields are extrapolated with an eighth-order in space, second-order in time, stress-particle-velocity, staggered-grid, finite-difference solution (equations~\ref{eqn:stress-velocity1} and \ref{eqn:stress-velocity2}). Convolutional perfectly matched layer (CPML) absorbing boundary conditions \citep{komatitsch07} are used on all six grid edges to reduce unwanted reflections.
The model (Figure~\ref{fig:3D_layermodel.eps}) has 5 m grid spacing in the x- y- and z-directions. 
Eight explosive sources with a 15 Hz Ricker wavelet are initiated and migrated one after another. The sources are evenly spaced on the surface along a circle with the center at (x, y) = (0.25, 0.25) km and radius = 0.02 km; 100 $\times$ 100 receivers are evenly spaced along the surface (z = 0.0 km) from  (x, y) = (0.0, 0.0) km to (0.5, 0.5) km, with 5 m spacing in both x- and y-directions; the time sample increment is 0.5 ms. Each source is recorded by all receivers.
\plot{3D_layermodel.eps}{width=1.0\columnwidth}
{
Two-layer model; the red spots are eight sources, evenly placed on the surface along a circle with the center at (x, y) = (0.25, 0.25) km and radius = 0.02 km. The PP and PS ADCIGs are obtained beneath the surface position (0.25, 0.25) km as marked by the blue arrow.
}

We use smoothed velocity and density models for ERTM, and apply the proposed 3D ERTM image condition. The migrated and stacked PP and PS images are shown in Figure~\ref{fig:3D_rfl_comb.eps}a and \ref{fig:3D_rfl_comb.eps}b. The PS image (Figure~\ref{fig:3D_rfl_comb.eps}b) has higher resolution and wider illumination than the PP image (Figure~\ref{fig:3D_rfl_comb.eps}a) because S-waves have shorter wavelengths and smaller reflection angles than the P-waves. \uline{The PP reflection angle in Figure~\ref{fig:3D_rfl_comb.eps}a is larger than the PS reflection angle in Figure~\ref{fig:3D_rfl_comb.eps}b. So the PS migrated images can get closer to the model edge, and the horizontal shape of the PS illumination follows the rectangular shape of the receiver array. The PP horizontal illumination is smaller and more rouded than the PS because of its smaller incident angle aperture.} Note that both the PP and PS images are single component (equation~\ref{eqn:reflectivity}) and, because the PS image has consistent polarities across the source position, they will stack constructively, which is an \marginpar{[1,10,12]} \uline{essential advantage over using curl operators. } 

\plot{3D_rfl_comb.eps}{width=0.8\columnwidth}
{
(a) PP and (b) PS stacked images obtained using 3D ERTM for eight sources using the vector based image conditions.
}

We obtain PP and PS ADCIGs at the surface center (x, y) = (0.25, 0.25) km (also marked in Figure~\ref{fig:3D_layermodel.eps} with the blue arrow).  The data for each of the eight sources, are migrated and the ADCIGs collapse to one point at the depth of the migrated image. 
%ADCIGs at positions 1 and 2 (Figure~\ref{fig:3D_layermodel.eps}) have the same incident angle but different azimuth angles; 1 and 3 have the same azimuth angle but different incident angles.  
The PP (Figure~\ref{fig:ADCIGs2.eps}a) and PS (Figure~\ref{fig:ADCIGs2.eps}b) ADCIG slices are shown in polar coordinates at the image depth (obtained by picking the maximum value within a depth window). The incident angles are indicated from the circle center ($0^{\circ}$) to the outer circle ($60^{\circ}$); the azimuth angles range from $-1800^{\circ}$ to $+180^{\circ}$ (counterclockwise). The image positions on the polar plots (Figure~\ref{fig:ADCIGs2.eps}) indicate the incident and azimuth angles of the reflections. The images from the eight sources are easily identified on the polar plots as they have the same incident angles and different azimuth angles. 
%and can be easily verified by the geometrical relations between the source and the ADCIG reflection positions.


\plot{ADCIGs2.eps}{width=0.9\columnwidth}
{
(a) PP and (b) PS ADCIG slices in a polar coordinate system at surface position (0.25, 0.25) km (the maximum values within a depth window centered at z = 0.25 km are plotted).  Notice the eight sources can be identified on the ADCIGs as they have the same incident angles and different azimuth angles.
}

In the second test, we construct a 3D elastic example using the SEG/EAGE 3-D Overthrust model (\url{http://geodus1.ta.tudelft.nl/seage3dm/}), which is an acoustic model containing only the P-velocity ($V_{P}$). To make the model elastic, we approximate $V_{S}$ by dividing the $V_{P}$ by 2 at each grid point.  The density is set to be a constant 2.4 $\mathrm{g/cm^3}$. Figure~\ref{fig:overthrust.eps}a shows three orthogonal slices through the $V_{P}$ volume containing the portion of the model used for this example; the size of this reduced volume (in grid points) is $151\times 151 \times 140$, and the spatial interval of the model is dx = dy = dz = 25 m. 256 sources are evenly placed in a square defined by x from 1.125 km to 2.625 km, y from 1.125 km to 2.652 km, and \marginpar{[15]}\uline{z = 0.025 km}. The sources are 15 Hz Ricker wavelets with 0.1 km intervals in both x and y directions. 151 $\times$ 151 receivers are evenly placed over the surface with a spacing of 25 m. The direct waves in the generated seismograms are removed.

\uline{Two image \marginpar{[1,4,6,13]} conditions are used and compared in this test. In addition to the proposed image condition, a vector based dot-product image condition \mbox{\citep{du17}} is also applied to provide benchmark results. 
%The two image conditions are theoretically the same as long as the propagation directions are accurately calculated by the Poynting vectors. 
The explicit forms and analytical comparisons between the two image conditions can be found in Appendix A. 
For both RTMs, we use the same smoothed velocity and density models (Figure~\ref{fig:overthrust.eps}b).  The migrated images using the dot-product image condition and the proposed image condition are shown in Figures~\ref{fig:over_rfl_comb1.eps}, and \ref{fig:over_rfl_comb2.eps}, respectively. Both images have (low amplitude) gaps where the steep dips and normal incidence coincide, as expected, because the steep dips are not well illuminated. Although both images are source normalized, the image amplitudes in Figure~\ref{fig:over_rfl_comb2.eps} are stronger than in Figures~\ref{fig:over_rfl_comb1.eps} because the proposed image condition allow wider incident angle information to be stacked (see the ADCIG comparisons below).}
\plot{overthrust.eps}{width=0.7\columnwidth}
{
(a) a portion of the Overthrust model (P-wave velocity) and (b) the smoothed model for ERTM.
}

\plot{over_rfl_comb1.eps}{width=0.7\columnwidth}
{
Migrated (a) PP image and (b) PS image using the dot-product image condition.
}
\plot{over_rfl_comb2.eps}{width=0.7\columnwidth}
{
Migrated (a) PP image and (b) PS image using the proposed image condition. The image amplitudes are stronger than those in Figure~\ref{fig:over_rfl_comb1.eps}.
}

\uline{Figures~\ref{fig:over_cig_dot.eps} and \marginpar{[4,6,13]} \ref{fig:over_cig_my.eps} show the PP (upper row) and PS (lower row) ADCIGs using the dot-product and the proposed image conditions, respectively.
 Both sets of ADCIGs are extracted below the same surface location (x, y) = (1.35, 1.85) km.  For viewing purposes, the azimuths of the ADCIGs are evenly binned into six bins from $\mathrm{0^\circ}$ to $\mathrm{360^\circ}$ around its surface position. 
Each bin contains the stacked ADCIGs over $\mathrm{30^\circ}$ of azimuth angle and their corresponding mirror azimuth, which are $\mathrm{180^\circ}$ apart from them (see the shaded area in the first row of Figures~\ref{fig:over_cig_dot.eps} and \marginpar{[4,6,13]} \ref{fig:over_cig_my.eps}). $\mathrm{0^\circ}$ azimuth corresponds to the positive x axis in figure~\ref{fig:overthrust.eps}, and $\mathrm{90^\circ}$ azimuth corresponds to the positive y axis.
The incident angles are collected from $\mathrm{0^\circ}$ to $\mathrm{50^\circ}$, and the signs of incident angles are determined reletively by their corresponding azimuth angles as indicated in Figures~\ref{fig:over_cig_dot.eps} and \ref{fig:over_cig_my.eps}. 
The events in the ADCIGs are flat over incident angles because smoothed velocity and density models are used for the ERTM. 
The migrated images from both image conditions (Figures~\ref{fig:over_rfl_comb1.eps} and \ref{fig:over_rfl_comb2.eps}) and their corresponding ADCIGs (Figures~\ref{fig:over_cig_dot.eps} and \ref{fig:over_cig_my.eps}) have good correspondence to the geological structures in the model. 
%??????Because of the source positions are evenly distributed and the ADCIGs are extracted beneath the center of the surface, the illumination for small incident angles is not as good as for medium-large incident angles as indicated in the PP ADCIGs from both schemes.
} 

\uline{The amplitudes \marginpar{[4]} of the PP ADCIGs in the dot-product image condition diminish as the open angle approaches $90^\circ$ (indicated by the black arrows in Figure~\ref{fig:over_cig_dot.eps}) because a multiplication of cos$(\psi$) is implicit in the dot-product image condition, where $\psi$ is the angle between the incident and reflected particle velocity vectors. For PP reflections, cos($\psi$) approaches 0 as the open angle $2\theta$ approaches $\mathrm{90^\circ}$. This problem is avoided using the proposed image condition (see the marked areas in Figure~\ref{fig:over_cig_my.eps}), which replaces cos($\psi$) with a sgn (-1 or 1) function, and thus gives wider angle apertures than the former (see Appendix A for detailed analysis). The amplitudes in the PS ADCIGs are also changed, but do not diminish at $2\theta=90^\circ$ because the S-wave particle velocity vector is perpendicular to its propagation direction, and $\psi$ is not the same as the open angle between the incident P- and converted S-waves.}
\plot{over_cig_dot.eps}{width=1.0\columnwidth}
{
(a) PP and (b) PS ADCIGs extracted at (x, y) = (1.35, 1.85) km plotted in six pie shaped azimuth angle bins from $\mathrm{0^\circ}$ to $\mathrm{360^\circ}$ in increments of $\mathrm{30^\circ}$, using the dot-product image condition. Areas marked with arrows in the PP ADCIGs indicate the attenuation effect of cos($\psi)$; compare with Figure~\ref{fig:over_cig_my.eps}.
}
\plot{over_cig_my.eps}{width=1.0\columnwidth}
{
(a) PP and (b) PS ADCIGs extracted at (x, y) = (1.35, 1.85) km plotted in six pie shaped azimuth angle bins from $\mathrm{0^\circ}$ to $\mathrm{360^\circ}$ in increments of $\mathrm{30^\circ}$, using the proposed image condition. Compare the areas marked with arrows with those in Figure~\ref{fig:over_cig_dot.eps}; the proposed image condition generates PP ADCIGs with wider open angles than in the dot-product image condition, because the cos($\psi)$ is not present in the proposed image condition.
}

\section{Discussion}

The proposed source-normalized magnitude-crosscorrelation elastic image conditions have several important differences from the source-normalized crosscorrelation image condition in acoustic RTMs \citep{kaelin06}. First, the magnitudes of the elastic particle-velocity vectors are used instead of amplitudes in acoustic wavefields. Second, for acoustic RTMs, only a single $\tau^P$ component amplitude needs to be stored during the source wavefield extrapolation, while in the proposed image condition for elastic RTM, all the P-wave particle-velocity and stress components are required at each grid point to build the final image. Third, because the magnitudes of the particle-velocity vectors are always positive, to get accurate reflectivity information, signs of the reflections (both PP and PS) need to be determined as a part of the image condition. The output of the ERTM contains approximate angle-dependent reflectivity information; to increase the accuracy of the reflectivity, compensations for transmission and attenuation losses \citep{deng07,deng08} are also necessary.

In the above examples, we store the source wavefield in disk as the models are small. However, for big 3D models, the wavefield storage and I/O burden may become costly. One solution is to store the boundaries or checkpoints during the source wavefield extrapolation \citep{bao15}, and to reconstruct the source wavefield during the receiver wavefield extrapolation.

\uline{The accuracy of Poynting vectors decreases as the model becomes complicated and wavefronts interfere with each other. Common solutions include increased smoothing of the velocity model, and precalculating the dip angles of the subsurface structures to provide additional information in constructing ADCIGs \mbox{\citep{zhang11}}. Some gaps at near-normal incident angles which are caused by ambiguities in the azimuth angle calculations, may appear in the PP ADCIGs. We use linear interpolation to fill the gaps for better viewing in Figures~\ref{fig:over_cig_dot.eps} and \ref{fig:over_cig_my.eps}. }

Compared with the excitation amplitude type image condition \citep{wenlong_vct15,wenlong_3d16}, the crosscorrelation type image condition involves substantially more wavefield storage and a large I/O burden, and thus is more computationally expensive; the main benefit is that multipathing can be handled efficiently and correctly.

The proposed image condition uses the relation between P- and S-wave directions and their corresponding polarization directions, which is valid in isotropic media. In anisotropic media, the relation is more complicated \citep{wang_cl16}, and an extension of this image condition to anisotropic ERTM needs further investigations.


\section{Conclusions}

\uline{A source-normalized \marginpar{[1,12]} magnitude-crosscorrelation image condition using signed magnitudes of elastic components is proposed and implemented in 3D ERTMs.} P- and S-waves are decomposed in the vector domain during both source and receiver wavefield extrapolation. Propagation directions for P- and S-waves are efficiently calculated using Poynting vectors with the decomposed P- and S-wave vectors as input, and make the process of generating ADCIGs much cheaper compared with other existing methods that involve extracting propagation directions from wavefronts. \marginpar{[1,12]}\uline{Comparisons with an existing vector-based dot-product image condition show PP ADCIGs with wider incident angles than the existing dot-product elastic image condition.}
%The vector-based image condition is based on the prestack excitation amplitude image condition which is a type of deconvolution image condition, and is efficient and robust.


%\section{Acknowledgments}
%
%The research leading to this paper is supported by the Sponsors of the
%UT-Dallas Geophysical Consortium and the Outstanding Young Talent Program (AUGA5710053217) from the Harbin Institute of Technology. A portion of the computations were done at the Texas Advanced Computing Center. This paper is Contribution No. xxxx
%from the Department of Geosciences at the University of Texas at Dallas.

\append{Relations and Differences between the proposed and the dot-product image condition}

%The only difference between the proposed image condition with the vector dot product image condition \citep{wang_cl16,zhu17}
%. First, the dot product image condition is a crosscorrelation-type image condition, which requires heavy I/O for saving and reading the source wavefields, while the proposed image condition is a excitation amplitude image condition that needs only a few maps (image time and some amplitude) from the source wavefield extrapolation. Second,
Both the proposed image condition and the vector dot product image condition \citep{wang_cl16,zhu17,du17} involve projections from vector wavefields to scalar images; the latter image condition applies a dot product, \marginpar{[1,4,5]}\uline{whereas our image condition calculates the signed magnitudes from the wavefields.}

To make the comparison vivid, we modify the proposed image condition \ref{eqn:reflectivity}, which is a source-normalized crosscorrelation image condition, to be a crosscorrelation type image condition without source normalization as follows
\begin{equation}
I_{pp}(x,y,z)=\sum_{t=0}^{T}\mathrm{sgn_{pp}}(x,y,z)|\mathbf{V^p_{rec}}(x,y,z,t)||\mathbf{V^p_{src}}(x,y,z,t)|,
\label{eqn:crsc1}
\end{equation}
and
\begin{equation}
I_{ps}(x,y,z)=\sum_{t=0}^{T}\mathrm{sgn_{ps}}(x,y,z)|\mathbf{V^s_{rec}}(x,y,z,t)||\mathbf{V^p_{src}}(x,y,z,t)|.
\label{eqn:crsc2}
\end{equation}

The non-normalized dot product image conditions can be written as
\begin{equation}
I_{pp}(x,y,z)=\sum_{t=0}^{T}\mathbf{V^p_{rec}}(x,y,z,t)\cdot \mathbf{V^p_{src}}(x,y,z,t),
\label{eqn:dprdt1}
\end{equation}
and
\begin{equation}
I_{ps}(x,y,z)=\sum_{t=0}^{T}\mathbf{V^s_{rec}}(x,y,z,t)\cdot \mathbf{V^p_{src}}(x,y,z,t),
\label{eqn:dprdt2}
\end{equation}
where $\mathbf{V_{rec}}$ and $\mathbf{V_{src}}$ are the decomposed (P or S) receiver and source vector wavefields. Recall that 
\begin{equation}
\mathbf{V_{rec}}\cdot \mathbf{V_{src}}=|\mathbf{V_{rec}}||\mathbf{V_{src}}|\mathrm{cos}(\psi),
\label{eqn:a3}
\end{equation}
where $\psi$ is the angle between the incident and reflected particle velocity vectors, and the $\mathrm{cos}(\psi)$ causes an image amplitude change which is not related to the subsurface properties. 
\marginpar{[4]}\uline{A solution proposed by \mbox{\citet{du17}} is to correct the image amplitudes by dividing the $I_{pp}$ and $I_{ps}$ by $[\mathrm{cos}(\psi) + \epsilon^2]$ (Equation~13 in \mbox{\citet{du17}}), where $\epsilon^2$ is a small number that prevents division by zero. This correction is valid if the calculation of $\psi$ is robust and accurate, but the correction accuracy decreases as $\psi$ approaches $90^\circ$.}
%Our image condition is theoretically equivalent to the amplitude corrected image condition in \mbox{\citet{du17}}. Besides, t
\marginpar{[1,4,5]}\uline{There is no need for amplitude correction in the proposed image condition, and $\psi$ doesn't need to be accurate as it is only used for sign determination. }
The only difference between image conditions (\ref{eqn:crsc1}) and (\ref{eqn:crsc2}), and image conditions (\ref{eqn:dprdt1}) and (\ref{eqn:dprdt2}), is that $\mathrm{cos}(\psi)$ is replaced by a sgn function in (\ref{eqn:crsc1}) and (\ref{eqn:crsc2}) that is pre-calculated in equations~\ref{eqn:sgn_ps}.


\newpage

\bibliographystyle{seg}  % style file is seg.bst
\bibliography{att}

\end{document}
